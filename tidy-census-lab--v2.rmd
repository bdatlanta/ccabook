---
title: "Tidy Census Lab"
author: "Bill Drummond"
date: "12/1/2021"
output: html_document
always_allow_html: true
---


## Setup the lab

Before running the lab 

| 1. You may need to secure a Census API key from:
|    https://api.census.gov/data/key_signup.html

| 2. And you may need to install the tidycensus package:
|    install.packages("tidycensus")


```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warnings = FALSE)
library(tidycensus)
library(tidyverse)
library(sf)
library(tmap)
library(RColorBrewer)


source("../functions/functions1c.R")
census_api_key(read_file(
  "c:/courses/cca/class2621/apikeycensus.txt"))

# census_api_key("Insert you apikey here")

```

## Fetch full variable listing from 2019 ACS

```{r}

acsvars19a = load_variables(2019, "acs5", cache = TRUE)

acsvars19b = acsvars19a %>%
  mutate(label = str_replace_all(label,"!!", "-"))
```

Spend five minutes browsing acsvars19b.

Note that Census data is organized into tables (the part before the underscore) and variable numbers (the part after the underscore).


## Search for keywords

You can search for keywords in the label field with code like this:

```{r}
x = acsvars19b %>% 
    filter(str_detect(tolower(label),"gini"))
y = acsvars19b %>% 
    filter(str_detect(tolower(label),"median")) %>% 
    filter(str_detect(tolower(label),"family")) %>%
    filter(str_detect(tolower(label),"income")) 

```
## Construct a variable list and dataframe with full variable information

To query the api construct a variable list

```{r}
varlist = c(gini =          "B19083_001",
            medhhinc =      "B19013_001", 
            medage =        "B01002_001",
            gini =          "B19083_001",
            totfamilies =   "B17019_001",
            povfamilies =   "B17019_002",
            nopfamilies =   "B17019_013",
            wmedhhinc =     "B19013A_001",
            bmedhhinc =     "B19013B_001",
            wnhmedhhinc =   "B19013H_001",
            totpop =        "B01003_001",
            whitenhpop =    "B01001H_001")
```


You'll also want to join the full variable information to your list.  Scan the varlistfull dataframe to make sure your list is correct.


```{r}
varlist1full = as.data.frame(varlist) %>% 
  rename(name = varlist) %>% 
  left_join(acsvars19b)

```


## Fetch variables and spatial data

Now you can pull your variables AND the census spatial files associated with them.

```{r echo = T, results = 'hide'}
usco1 = get_acs(geography = "county",
                        geometry = TRUE,
                        year = 2019,
                        variables = varlist) 

usst1 = get_acs(geography = "state",
                geometry = TRUE,
                year = 2019,
                variables = varlist) 
```


Now we'll clean the data to the 50 states (and DC)

```{r}
usco2 = usco1 %>% 
  tolow() %>% 
  filter(geoid <= '56999') %>% 
  select(name,geoid,varname=variable,datavalue=estimate)     

usst2 = usst1 %>% 
  tolow() %>% 
  filter(geoid <= '56999') %>% 
  select(name,geoid,varname=variable,datavalue=estimate)
```

And map it with tmap.

```{r}
tmap_mode("view")

tm_shape(subset(usco2,varname=="gini")) +
  tm_polygons("datavalue",palette="-RdYlBu") +
tm_shape(subset(usst2,varname=="gini")) +
  tm_borders("black",lwd=1.25)
```

## Calculating quantiles

Or, we can divide all counties and all variables into quintiles (lowest  20%, lower 20%, middle 20%, higher 20%, highest20%)

```{r}
usco3 = usco2 %>% 
  group_by(varname) %>% 
  mutate(quintile = ntile(datavalue,5))

usst3 = usst2 %>% 
  group_by(varname) %>% 
  mutate(quintile = ntile(datavalue,5))
```

## Mapping by quantiles

```{r}
tm_shape(subset(usco3,varname=="gini")) +
  tm_polygons("quintile",palette="-RdYlBu") +
tm_shape(subset(usst3,varname=="gini")) +
  tm_borders("black",lwd=1.25)
```


## Saving datasets

Finally, save your equity datasets to quickly add an equity analysis as an additional dimension to any spatial analysis.

You can also save them as shapefiles for use in traditional GIS packages.


```{r}
saveRDS(usco3,"countyequity.rds")
saveRDS(usst3,"stateequity.rds")
st_write(usco3,"coequity.shp")
st_write(usst3,"stequity.shp")
```







